# 4. 输入输出系统

## 4.1 概述

计算机的输入输出设备有键盘、鼠标、显示器、网卡、打印机、CD等等，操作系统需要一种统一的方法来管理各种各样的设备。下图就是操作系统提供的方案，从下往上讲。

![](./pic/4-输入输出概述.jpg)

### 4.1.1 用设备控制器屏蔽设备差异

计算机有多种设备控制器，例如磁盘控制器用来控制各种各样的磁盘设备，USB控制器用来控制各种USB设备，显示器也对应有显示器控制器。

设备控制器就像一个小电脑一样，有自己的芯片可以执行逻辑，有自己的寄存器，CPU通过写这些寄存器，对控制器下指令。通过读这些寄存器，查看控制器对设备的操作状态。

输入输出设备大致可以分为两类：

- 块设备：将信息存储在固定大小的块中，每个块都有自己的地址，例如硬盘。
- 字符设备，发送和接收的都是字节流，不用考虑任何块结构，无法寻址，例如鼠标。

对于块设备的读写，因为数据量比较大，控制器会有缓冲区。需要攒够一定的数据才读出或写入。

CPU如何与控制器的寄存器以及数据缓冲区通信？

- 给每个控制寄存器分配一个I/O端口，通过特殊得汇编指令操作这些寄存器。
- 通过内存映射，分配一段内存空间给数据缓冲区，就可以向读写内存一样读写数据缓冲区，内存空间的ioremap就是做这个的。

CPU给设备控制器下达命令后就可以去干自己的事了，当设备控制器做完之后，会利用中断处理器发送一个中断，通知CPU任务已经完成，CPU需要停下当前的任务来处理中断。

由中断处理器发出的中断叫做硬件中断，通过系统调用产生的叫做软中断。

对于磁盘来说，有一个DMA芯片来协助读取数据，CPU发送读请求给DMA，告诉它去哪里取，取多少数据。DMA发送指令给磁盘控制器，去磁盘上读出数据后放到指定内存区域，然后发送中断告诉CPU数据准备好了。

### 4.1.2 用驱动程序屏蔽设备控制器差异

由于各种设备控制器的寄存器，缓冲区，指令都不同，对于操作系统来说，还需要一种途径来屏蔽这个差异。设备驱动程序就是起到这个作用的。

设备控制器不是操作系统的一部分，设备驱动程序属于操作系统，内核可以像调用本地代码一样调用驱动程序的代码，驱动程序的代码需要发出特殊的面向设备控制器的指令，才能操作设备控制器。

驱动程序有统一的接口供操作系统调用，这样操作系统就能以统一方式，无视设备的区别，调用设备驱动程序。

中断处理的逻辑也是写在设备驱动程序里的。当一个设备驱动程序初始化时，要先注册一个该设备的中断处理函数，中断返回的时候，是切换进程的时机，这个时候就可以找到设备驱动程序注册的中断处理函数Handler，然后执行它进行中断处理。

对于块设备来说，在驱动程序之上，文件系统之下，有一层通用块设备层，将与块设备相关的通用逻辑放在这一层，维护与设备无关的块的大小，然后通用块层下面对接各种各样的驱动程序。

### 4.1.3 用文件系统接口屏蔽驱动程序的差异

从硬件设备到设备控制器，到驱动程序，到通用块层，到文件系统，层层屏蔽不同的设备的差别，最终到这里涉及对用户使用接口，也要统一。

用户操作设备都是基于文件系统的接口，也有统一的标准。

首先是由统一的设备名称，所有的设备都在/dev/文件下创建一个特殊得设备文件。这个设备文件也有inode，但是不关联到硬盘或任何其他存储介质上的数据，而是建立了与某个设备驱动程序的连接。