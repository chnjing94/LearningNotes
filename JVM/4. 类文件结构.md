## 4.1 Class类文件结构

### 4.1.1 魔数与Class文件的版本

- 魔数的唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件
- Jpg, gif图片中都有魔数，使用魔数而不是使用文件扩展名来失败文件类型是出于安全考虑，因为扩展名可以改变
- Class文件的魔数为0xCAFEBABE
- 紧接着魔数的4个字节存储Class文件的版本号(与jdk版本有关)
- JVM不接受超过其版本号的Class文件

### 4.1.2 常量池

- 版本号之后是常量池入口

- 可以理解为Class文件的资源仓库，是与其他项目关联最多的数据类型，也是占用空间最大的数据项目之一

- 常量池主要存放两大类常量

  1. 字面量，如文本字符串，声明为final的常量值等。

  2. 符号引用，包含三类常量:

     - 类和接口的全限定名
     - 字段的名称和描述符
     - 方法的名称和描述符

     符号引用会在类创建时或运行时解析，翻译到具体的内存地址中。

- Class文件中定义的方法名，字段名的长度不能超过64K
- Class文件字节码的工具：javap -verbose

### 4.1.3 访问标志

- 常量池结束后，紧接着的两个字节代表访问标志，用于识别一些类或者接口层次的访问信息
- 例如，这个类是Class还是接口，是否为public，是否为abstract，如果是类，是否为final等

### 4.1.4 类索引，父索引与接口索引集合

- 类索引（this_class）和父类索引（super_class）和接口索引（interfaces）是一组u2类型的数据集合，Class文件中由这三项数据来确定这个类的继承关系。

### 4.1.5 字段表集合

- 字段表（field_info）用于描述接口或者类中声明的变量
- 字段包括类级变量以及实例级变量
- 可以包括的信息为，作用域，是类变量还是实例变量，可变性，并发可见性，数据类型等

- 字段表集合不会列出从超类或者父接口继承而来的字段

### 4.1.6 方法表集合

- 对方法的描述包括，访问标志，名称索引，描述符索引，属性表集合
- 方法内的代码被编译后，放在方法属性表集合中一个名为“Code”的属性里面
- 如果父类方法在子类中没有被重写，方法表集合中就不会出现来自父类的方法信息
- 在Class文件里面，可以有两个方法，返回值不同，但其他描述符完全相同，但在Java层面不允许

### 4.1.7 属性表集合

在Class文件，字段表，方法表中都可以携带自己的属性表集合

1. Code属性：Java方法体中的代码经过编译处理后，变成字节码存储在Code属性内，方法不允许超过65535条字节码。
2. Exceptions属性：作用是列举出方法中可能抛出的受检查异常，也就是在throws关键字后面列举的异常
3. LineNumberTable属性：用于描述Java源码行号与字节码行号之间对应关系，如果取消生成这项信息，抛出异常时，则不会显示行号
4. LocalVariableTable属性：用于描述栈帧中局部变量表中的变量与Java源码中定义的变量之间的关系，如果取消生成，其他人引用这个方法时，参数名称都会丢失，IDE会使用诸如arg0，arg1之类的占位符代替原有参数名。
5. SourceFile：用于记录生成这个Class文件的源码文件名称，如果取消生成，抛出异常时，堆栈中将不会显示出错代码所属的文件名。
6. ConstantValue属性：作用是通知虚拟机自动为静态变量赋值。只有被static关键字修饰的变量（类变量）才可以使用这项属性。
7. InnerClasses属性：用于记录内部类与宿主类之间的关联。如果一个类中定义了内部类，那编译器将会为它以及它所包含的内部类生成InnerClass属性。
8. Deprecated和Synthetic属性：Deprecated用于表示某个类，字段或者方法，被程序作者定为不再推荐使用。Synthetic表示此字段或者方法不是由Java源文件直接产生的。
9. StackMapTable属性：这个属性会在类加载的字节码验证阶段被新类型检查验证器使用，使用新的检查器目的在于替代以前的比较消耗性能的验证器，大幅提升字节码验证的性能。
10. .Signature属性：可以出现在类，字段和方法表结构的属性表中。主要作用是记录泛型签名信息，来弥补泛型擦除带来的缺陷（例如用反射无法得到泛型信息）。
11. BootstrapMethods属性：用于保存invokedynamic指令引用的方法限定符。

### 4.2 字节码指令介绍

- 因为限定了虚拟机操作码的长度为一个字节，所以指令集的操作码总数不能超过256个。
- 因为总量有限，不能为每种类型创建一种命令，因此大多数对于boolean、byte、short和char类型的操作，实际上都是使用相应的int类型作为运行类型。
- 虽然类实例和数组都是对象，虚拟机对实例对象和数组的创建与操作使用了不同的字节码指令。
- 同步指令：虚拟机通过从方法常量池的ACC_SYNCHRONIZED标志来判断一个方法是否声明为同步方法。如果是就要求线程成功持有管程，指令集中monitorenter和monitorexit两条指令是用来支持synchronized关键字的。



